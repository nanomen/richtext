<html>
<head>
    <title>Test socket.io</title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
    <!-- Main Quill library -->
    <script src="https://cdn.quilljs.com/1.0.6/quill.min.js" type="text/javascript"></script>

    <!-- Theme included stylesheets -->
    <link href="https://cdn.quilljs.com/1.0.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.0.6/quill.bubble.css" rel="stylesheet">

    <!-- Core build with no theme, formatting, non-essential modules -->
    <link href="https://cdn.quilljs.com/1.0.6/quill.core.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.0.6/quill.core.js" type="text/javascript"></script>
</head>
<body>
  <div>
    <!-- <textarea id="textarea" style="width: 500px; height: 500px;"></textarea> -->
    <div id="inputTextarea" style="width: 500px; height: 500px;border: 1px solid red;padding: 10px;"></div>
  </div>
<script>
  var socket = io('https://fast-castle-17277.herokuapp.com/');
  var Delta = Quill.import('delta');
  var editor = new Quill('#inputTextarea');
  var change = new Delta();

  //console.log(editor);


  // quill.getContents();


  /*quill.on('text-change', function(delta) {
    change = change.compose(delta);
  });*/

  socket.on('connect', function(){
    console.log('connect');
  });

  socket.on('disconnect', function(){
    console.log('disconnect');
  });

  socket.on('setInitData', function(_initText) {
    console.trace('setchange', _initText);
    quill.updateContents({
      ops: [
      { insert: _initText }
      ]
    });
  });

  socket.on('setchange', function (data) {
    editor.updateContents(data.msg);
  });

  editor.on('text-change', function(delta, oldDelta, source) {

    if (source === 'user') {
        change = change.compose(delta);

        if (change.length() > 0) {
        //console.log('Saving changes', JSON.stringify(change));

        socket.emit('sendchange', {
          change: change
        });

        socket.emit('setInitText', {
          initText: editor.getText()
        });

        change = new Delta();
      }
    }

    /*if (source === 'api') {
      console.log("An API call triggered this change.");
    } else if (source === 'user') {

      if (change.length() > 0) {
        //setTimeout(function(){
          socket.emit('sendmsg', {
            msg: change
          });
          change = new Delta();
        //}, 2000);
      }
    }*/

  });

  // Save periodically
  /*setInterval(function() {
    if (change.length() > 0) {
      //console.log('Saving changes', JSON.stringify(change));

      socket.emit('sendmsg', {
        msg: change
      });

      change = new Delta();
    }
  }, 1000);*/

</script>
</body>
</html>