<html>
<head>
    <title>Test socket.io</title>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
    <!-- Main Quill library -->
    <script src="https://cdn.quilljs.com/1.0.6/quill.js" type="text/javascript"></script>

    <!-- Theme included stylesheets -->
    <link href="https://cdn.quilljs.com/1.0.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.0.6/quill.bubble.css" rel="stylesheet">
</head>
<body>
  <div style="width: 500px; height: 500px;">
    <!-- <textarea id="textarea" style="width: 500px; height: 500px;"></textarea> -->
    <div id="toolbar">
      <!-- Add font size dropdown -->
      <select class="ql-size">
        <option value="small"></option>
        <!-- Note a missing, thus falsy value, is used to reset to default -->
        <option selected></option>
        <option value="large"></option>
        <option value="huge"></option>
      </select>
      <!-- Add a bold button -->
      <button class="ql-bold"></button>
      <!-- Add subscript and superscript buttons -->
      <button class="ql-script" value="sub"></button>
      <button class="ql-script" value="super"></button>
    </div>
    <div id="inputTextarea"></div>
  </div>
<script>
  var socket = io('https://fast-castle-17277.herokuapp.com/');
  var Delta = Quill.import('delta');
  var Toolbar = Quill.import('modules/toolbar');

  Quill.register('modules/toolbar', Toolbar);

  var editor = new Quill('#inputTextarea', {
    modules: {
      toolbar: '#toolbar'
    },
    theme: 'snow'
  });
  var change = new Delta();

  //console.log(editor);


  // quill.getContents();


  /*quill.on('text-change', function(delta) {
    change = change.compose(delta);
  });*/

  socket.on('connect', function(){
    console.log('connect');
  });

  socket.on('disconnect', function(){
    console.log('disconnect');
  });

  socket.on('setInitData', function(_initData) {
    console.trace('setchange', _initData);
    editor.updateContents(_initData);
    /*editor.updateContents({
      ops: [
        { insert: _initText }
      ]
    });*/
  });

  socket.on('setchange', function (data) {
    editor.updateContents(data.change);
  });

  editor.on('text-change', function(delta, oldDelta, source) {

    if (source === 'user') {
        change = change.compose(delta);

        if (change.length() > 0) {
        //console.log('Saving changes', JSON.stringify(change));

        socket.emit('sendchange', {
          change: change
        });

        socket.emit('setInitText', {
          initData: editor.getContents()
        });

        change = new Delta();
      }
    }

    /*if (source === 'api') {
      console.log("An API call triggered this change.");
    } else if (source === 'user') {

      if (change.length() > 0) {
        //setTimeout(function(){
          socket.emit('sendmsg', {
            msg: change
          });
          change = new Delta();
        //}, 2000);
      }
    }*/

  });

  // Save periodically
  /*setInterval(function() {
    if (change.length() > 0) {
      //console.log('Saving changes', JSON.stringify(change));

      socket.emit('sendmsg', {
        msg: change
      });

      change = new Delta();
    }
  }, 1000);*/

</script>
</body>
</html>